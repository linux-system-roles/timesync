---
- name: Set version specific variables
  include_vars: "{{ item }}"
  with_first_found:
    - "{{ ansible_distribution }}_{{ ansible_distribution_version }}.yml"
    - "{{ ansible_distribution }}_{{ ansible_distribution_major_version }}.yml"
    - "{{ ansible_distribution }}.yml"
    - "{{ ansible_os_family }}.yml"
    - "default.yml"

- name: Check if only NTP is needed
  set_fact:
    timesync_mode: ntp
  when: timesync_ptp_domains|length == 0

- name: Check if single PTP is needed
  set_fact:
    timesync_mode: ptp
  when:
    - timesync_mode is not defined
    - timesync_ntp_servers|length in [0,1]
    - timesync_ptp_domains[0].interfaces|length == 1

- name: Check if both NTP and PTP are needed
  set_fact:
    timesync_mode: ntpptp
  when: timesync_mode is not defined

- name: Perform NTP mode tasks
  import_tasks: ntp.yml
  when:
    - "'ntp' in timesync_mode"

- name: Install PTP package
  import_tasks: install_pkg.yml
  vars:
    __timesync_pkg: "{{ timesync_linuxptp_pkg }}"
  when: "'ptp' in timesync_mode"

- name: Perform PTP mode tasks
  import_tasks: ptp.yml
  when:
    - timesync_mode == 'ptp'

- import_tasks: tasks/generate_conf_file.yml
  vars:
    __timesync_template: "{{ timesync_timemaster_conf_template }}"
    __timesync_path: "{{ timesync_timemaster_conf_path }}"
    __timesync_notify: "restart timemaster"
  when:
    - timesync_mode == 'ntpptp'
    - "'linuxptp' in ansible_facts.packages"

- name: Disable services
  import_tasks: disable_service.yml

- name: Enable services
  import_tasks: enable_service.yml
