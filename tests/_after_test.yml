- hosts: all
  gather_facts: false
  tasks:
    - name: Include test vars
      include_vars: vars/main.yml

    - name: Remove packages
      package:
        name: "{{ __timesync_packages }}"
        state: absent

    - name: Restore files modified by these role tests
      command: tar xfP {{ __timesync_tar }}

    - name: Read saved system services state
      slurp:
        src: "{{ __timesync_services_json }}"
      register: __timesync_services_raw

    - name: Restore services to correct state
      service:
        name: "{{ __item['name'] }}"
        state: "{{ (__item['state'] == 'running') |
          ternary('restarted', 'stopped') }}"
        enabled: "{{ __item['status'] == 'enabled' }}"
      loop: "{{ __timesync_services }}"
      ignore_errors: true
      vars:
        __system_services: "{{ __timesync_services_raw['content'] |
          b64decode | from_json }}"
        __sys_item: "{{ __system_services |
          selectattr('name', 'match', '^' ~ item ~ '$') }}"
        __item: "{{ __sys_item[0] if __sys_item else
          {'name': item, 'state': 'stopped', 'status': 'disabled'} }}"
