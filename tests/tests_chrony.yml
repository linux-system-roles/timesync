---
- name: Configure time synchronization with NTP servers
  hosts: all
  vars:
    timesync_chrony_custom_settings:
      - "logdir /var/log/chrony"
      - "log tracking"
    timesync_ntp_servers:
      - hostname: 172.16.123.1
      - hostname: 172.16.123.2
        iburst: true
        minpoll: 4
      - hostname: 172.16.123.3
        pool: true
        iburst: true
        minpoll: 4
        maxpoll: 6
    timesync_ntp_provider: chrony
    timesync_step_threshold: 0.01
    timesync_dhcp_ntp_servers: true
    timesync_min_sources: 2

  tasks:
    - name: Run the role
      include_role:
        name: linux-system-roles.timesync
        public: true
      when: not __bootc_validation | d(false)

    - name: Run the role only to get vars needed for validation
      include_role:
        name: linux-system-roles.timesync
        public: true
        tasks_from: set_vars.yml
      when: __bootc_validation | d(false)

    - name: Run chrony tests
      tags: tests::verify
      block:
        - name: Flush handlers
          meta: flush_handlers
          when: not __bootc_validation | d(false)

        - name: Wait for services to start
          wait_for:
            timeout: 2
          when: not __bootc_validation | d(false)

        - name: Create QEMU deployment during bootc end-to-end test
          delegate_to: localhost
          command: "{{ lsr_scriptdir | quote }}/bootc-buildah-qcow.sh {{ ansible_host | quote }}"
          changed_when: true
          when: ansible_connection == "buildah"

        - name: Check headers for ansible_managed, fingerprint
          include_tasks: tasks/check_header.yml
          loop:
            - "{{ timesync_chrony_conf_path }}"
            - "{{ timesync_chrony_sysconfig_path }}"
          loop_control:
            loop_var: __file
          vars:
            __fingerprint: "system_role:timesync"

        # check settings in files - only check we can do in non-booted mode
        - name: Check for settings in chrony.conf
          command: grep -q {{ item | quote }} {{ timesync_chrony_conf_path }}
          loop: "{{ timesync_chrony_custom_settings +
            (timesync_ntp_servers | selectattr('hostname') | map(attribute='hostname') | list) +
            ['makestep ' ~ timesync_step_threshold ~ ' 3'] +
            ([sourcedirstr] if sourcedirstr | length > 0 else []) }}"
          vars:
            sourcedirstr: "{{ 'sourcedir ' ~ timesync_chrony_dhcp_sourcedir
              if timesync_dhcp_ntp_servers and timesync_chrony_dhcp_sourcedir
              else '' }}"
          changed_when: false

        - name: Skip remaining checks unless booted
          meta: end_host
          when: not __timesync_is_booted

        - name: Get list of currently used time sources
          shell: chronyc -n sources || ntpq -pn
          register: sources
          changed_when: false

        - name: Check time sources
          assert:
            that:
              - "'172.16.123.1' in sources.stdout"
              - "'172.16.123.2' in sources.stdout"
              - "'172.16.123.3' in sources.stdout"

        - name: Get list of log files
          command: ls /var/log/chrony/
          register: logfiles
          changed_when: false

        - name: Check log generated files
          assert:
            that:
              - "'tracking.log' in logfiles.stdout"

      always:
        - name: Cleanup after tests
          include_tasks: tasks/cleanup.yml
